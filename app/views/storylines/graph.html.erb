<h2 class="floating_header"><%= link_to "Storeys", storylines_path %></h2>

<div id="viz_wrapper"></div>

<%= javascript_include_tag "d3" %>

<script type="text/javascript">
function d3viz() {
  var activeNode = null;
  $().ready(function() {  
    $('#edit_dialog').hide();
    $('#edit_dialog_button').click(function() {
      if (activeNode.dashed) {
        jnodes.push({"name": $('#edit_dialog_text').val(), "group": jnodes[activeNode.parentIndex].group+1, "stroke": 2});
        jlinks.push({"source": activeNode.parentIndex, "target": jnodes.length-1, "value":1});
        // Update
        $.post("<%= graph_add_storylines_path %>",
          { "parent_id": jnodes[activeNode.parentIndex].real_id, "line": $('#edit_dialog_text').val() },
          function(data) {} );
      }
      else{
        activeNode.name = $('#edit_dialog_text').val();
        // Update
        $.post("<%= graph_update_storylines_path %>",
          { "id": activeNode.real_id, "line": $('#edit_dialog_text').val() },
          function(data) {} );
      }
      $('#edit_dialog').hide();
      supdate();
    });
  });
  function openEditDialog(d) {
    activeNode = d;
    if (activeNode.dashed) {
      $('#edit_dialog_button').val("Add");
      $('#edit_dialog_text').val("");   
    }
    else {
      $('#edit_dialog_button').val("Edit");
      $('#edit_dialog_text').val(d.name);    
    }
    $('#edit_dialog').show();
    dialog_count = 0;
    $(document).bind('click.graph_dialog', function(e) {
      if (!$(e.target).parents().hasClass('edit_dialog') && dialog_count > 0) {
        $('#edit_dialog').hide();
        $(document).unbind('click.graph_dialog');
      }
      dialog_count++;
    });
  }

  // Original code courtesy of http://bl.ocks.org/1846692
  var w = 1280,
      h = 720,
      color = d3.scale.category20(),
      jnodes, jlinks,
      link, node,
      nodeCircles, nodePaths, linkObjs;
  var vis = d3.select("#viz_wrapper").append("svg:svg")
      .attr("width", "100%")
      .attr("height", "100%");

  // Pan and Zoom
  // http://groups.google.com/group/d3-js/browse_thread/thread/346e75ba083fba4b
  vis.append("rect") 
    .attr("width", "100%") 
    .attr("height", "100%") 
    .attr("fill", "#fcfcfc") 
    .call(d3.behavior.zoom() 
      .on("zoom", function() { 
        vis.attr("transform", "translate(" + d3.event.translate + 
          ")scale(" + d3.event.scale + ")"); 
     })); 
  vis = vis.append("g"); 

  // Force Layout
  var force = self.force = d3.layout.force()
    .gravity(.05)
    .distance(function(d) { return 100 * d.value })
    .charge(function(d) { if (d.dashed) return -5000; else return -5000/(d.group/2+1); })
    .size([w, h]);
  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });
    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
  });

  // Ajax Call
  d3.json("<%= storyline_path(@storyline, :format => 'json') %>", function(json) {
    jnodes = json.nodes;
    jlinks = json.links;
    supdate();
  });

  function supdate() {
    force.nodes(jnodes).links(jlinks).start(); // Restart force layout

    // Link Additions
    linkObjs = vis.selectAll("line.link")
      .data(jlinks)
      .enter().insert("svg:line", ":first-child");
    linkUpdateHelper();
    vis.selectAll("line.link").data(jlinks).exit().remove();
  
    // Link Updates
    linkObjs = vis.selectAll("line.link")
      .data(jlinks)
      .selectAll("line");
    linkUpdateHelper();

    // Node Additions
    node = vis.selectAll("g.node")
      .data(jnodes)
      .enter().append("svg:g")
      .attr("class", "node")
      .call(force.drag);
    nodeCircles = node.append("circle");
    nodePaths = node.append("path");
    updateHelper();
    vis.selectAll("g.node").data(jnodes).exit().remove();
  
    // Node Updates
    node = vis.selectAll("g.node")
      .data(jnodes).call(force.drag);
    nodeCircles = node.selectAll("circle");
    nodePaths = node.selectAll("path");
    updateHelper();

    link = vis.selectAll("line.link");  
    node = vis.selectAll("g.node");
  }

  function linkUpdateHelper() {
    linkObjs.attr("class", "link")
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });
  }

  function updateHelper() {
    // Set Circle
    nodeCircles
      .attr("class", "circle")
      .attr("r", 50)
      .attr("fill", "white")
      .attr("stroke", function(d) { return color(d.group); })
      .attr("stroke-width", function(d) { return d.stroke+"px"; })
      .attr("stroke-dasharray", function(d) { if (d.dashed) return "5 3"; } )
      .on("click", openEditDialog);
  
    node.selectAll("text").remove(); // Clear all existing text
  
    // Set Text
    node.each(function(d) {
      var curr = d3.select(this);
      var words = d.name.replace(/^\s+|\s+$/g,"").split(" ");
      var lineArray = [];
      var numWords = Math.sqrt(words.length) | 0 + 1;
      var numLines = Math.ceil(words.length / numWords);
      var fontSize = 16;
      var yOffset = -numLines*fontSize/2;
      if (d.dashed) {
        fontSize = 24;
        yOffset -= 9;
      }
      var textElt = curr.append("svg:text")
       .attr("class", "nodetext")
       .attr("dx", 0).attr("y", yOffset+"px")
       .attr("text-anchor", "middle")
       .style("font-size", fontSize+"px");
      var index = 0;
      while(index < words.length) {
       var tempWords = "";
       for (var j = 0; j < numWords; j++) {
         if (j + index < words.length) {
           tempWords += words[j+index]+" ";
         }
       }
       var tempNode = textElt.append("svg:tspan").text(tempWords).attr("dy", "1em").attr("x", 0);
       index += numWords;
      }
      d.radius = Math.max(textElt.node().getBBox().width, textElt.node().getBBox().height) / 2 + 8;
    });
   
    // Set Real Radius (can only do this after we've determined how large the text box is)
    node.selectAll("circle").attr("r", function(d) { return d.radius; } );
   
    // Set Arc
    nodePaths
      .attr("d", d3.svg.arc()
       .innerRadius(function(d) { if (d.age) return d.radius+d.stroke+1; else return 0; })
       .outerRadius(function(d) { if (d.age) return d.radius+d.stroke+3; else return 0; })
       .startAngle(0).endAngle(function(d) { if (d.age) return Math.max(0, 1-d.age)*2*Math.PI; else return 0; }))
      .style("fill", function(d) { return color(d.group); })
      .style("stroke", function(d) { return color(d.group); });
  }
}
d3viz();
</script>

<div id="edit_dialog" class="edit_dialog">
  <div>
    <form>
    <textarea id="edit_dialog_text"></textarea><br />
    <input type="button" id="edit_dialog_button" value="Edit" />
    </form>
  </div>
</div>

<footer class="floating_footer">
  <%= link_to 'Back', storylines_path %> Â· 
  <%= link_to 'Story View', @storyline %>
</footer>